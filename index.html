<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>学習支援ポータル</title>
    <!-- Tailwind CSSの読み込み -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fontsの読み込み (気品のあるセリフ体) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;700&display=swap" rel="stylesheet">
    <!-- Microsoft Authentication Library (MSAL) for JS -->
    <script src="https://alcdn.msauth.net/browser/2.14.2/js/msal-browser.min.js"></script>
    <style>
        /* ... 既存のカスタムスタイルは変更ありません ... */
        body {
            font-family: 'Noto Serif JP', serif;
            background-color: #0a192f; /* 深い紺色 */
            color: #e6f1ff; /* やわらかな白色 */
        }
        .nav-link {
            transition: all 0.3s ease;
            position: relative;
            padding-bottom: 8px;
        }
        .nav-link::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0;
            height: 2px;
            background-color: #ffd700; /* 金色 */
            transition: width 0.3s ease;
        }
        .nav-link:hover::after,
        .nav-link.active::after {
            width: 100%;
        }
        .card {
            background-color: #172a45; /* やや明るい紺色 */
            border: 1px solid #304a6e;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }
        .search-input {
            background-color: #0a192f;
            border: 1px solid #304a6e;
            color: #e6f1ff;
        }
        .btn-primary {
            background-color: #ffd700;
            color: #0a192f;
            font-weight: bold;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .btn-primary:hover {
            background-color: #f0c400;
            transform: scale(1.05);
        }
        .btn-primary:disabled {
            background-color: #a08d3a;
            cursor: not-allowed;
            transform: none;
        }
        .form-input {
            background-color: #172a45;
            border: 1px solid #304a6e;
            color: #e6f1ff;
        }
        .form-input:focus {
            outline: none;
            border-color: #ffd700;
            box-shadow: 0 0 0 2px rgba(255, 215, 0, 0.5);
        }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #ffd700;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="antialiased">

    <!-- 初回訪問時表示エリア -->
    <div id="welcome-screen" class="hidden fixed inset-0 bg-black bg-opacity-95 z-50 flex items-center justify-center p-4">
        <div class="text-center text-white max-w-3xl w-full">
            <div id="welcome-message">
                <h1 class="text-4xl md:text-5xl font-bold mb-4 text-yellow-300">ようこそ</h1>
                <p class="text-lg md:text-xl mb-8">このサイトへお越しいただき、ありがとうございます。<br>あなたの学びをサポートするための特別な空間です。まずは、短い紹介動画をご覧ください。</p>
                <button id="play-intro-button" class="btn-primary py-3 px-8 rounded-lg text-lg">紹介動画を再生する</button>
            </div>
            <div id="intro-video-container" class="hidden aspect-video w-full">
                <video id="intro-video" class="w-full h-full" controls></video>
                <button id="close-intro-button" class="btn-primary py-2 px-6 rounded-lg text-md mt-4">サイトへ進む</button>
            </div>
        </div>
    </div>

    <!-- ログイン画面 -->
    <div id="login-screen" class="hidden min-h-screen flex items-center justify-center">
        <div class="text-center p-8 card max-w-md mx-auto">
            <h1 class="text-3xl font-bold mb-4 text-yellow-300">学習支援ポータルへようこそ</h1>
            <p class="text-slate-300 mb-8">コンテンツを閲覧するには、Microsoftアカウントでサインインしてください。</p>
            <button id="signInButton" class="btn-primary py-3 px-8 rounded-lg text-lg">Microsoftアカウントでサインイン</button>
        </div>
    </div>

    <!-- メインコンテンツエリア (ログイン後に表示) -->
    <div id="main-content" class="hidden">
        <header class="bg-slate-900/80 backdrop-blur-sm sticky top-0 z-40 w-full border-b border-slate-700">
            <div class="container mx-auto px-4">
                <div class="flex items-center justify-between h-20">
                    <div class="text-2xl font-bold text-yellow-400">
                        学習支援ポータル
                    </div>
                    <nav class="hidden md:flex items-center space-x-8 text-lg">
                        <a href="#video-booth" class="nav-link active">動画視聴</a>
                        <a href="#document-booth" class="nav-link">資料・課題</a>
                        <a href="#request-booth" class="nav-link">リクエスト</a>
                    </nav>
                     <div class="flex items-center">
                        <select id="mobile-nav" class="md:hidden bg-slate-800 border border-slate-600 rounded-md p-2 text-white mr-4">
                            <option value="#video-booth">動画視聴</option>
                            <option value="#document-booth">資料・課題</option>
                            <option value="#request-booth">リクエスト</option>
                        </select>
                        <div id="account-info" class="text-sm mr-4 hidden md:block"></div>
                        <button id="signOutButton" class="text-sm text-slate-300 hover:text-yellow-400 transition">サインアウト</button>
                    </div>
                </div>
            </div>
        </header>

        <main class="container mx-auto p-4 md:p-8">
            <!-- 各コンテンツセクション -->
            <section id="video-booth" class="page-section">
                 <!-- ... 動画ブースのHTMLは変更ありません ... -->
            </section>

            <section id="document-booth" class="page-section hidden">
                <!-- ... 資料ブースのHTMLは変更ありません ... -->
            </section>

            <section id="request-booth" class="page-section hidden">
                <h2 class="text-3xl font-bold mb-6 border-l-4 border-yellow-400 pl-4">リクエストブース</h2>
                <div class="card p-8 max-w-2xl mx-auto">
                    <p class="mb-6 text-slate-300">学習コンテンツに関するリクエストや、サイトに関するご意見・ご要望をお寄せください。参考資料などがあれば、ファイルを添付してください。</p>
                    <form id="request-form">
                        <div class="mb-4">
                            <label for="name" class="block mb-2">お名前（ニックネーム可）</label>
                            <input type="text" id="name" name="name" class="form-input w-full p-2 rounded-md" required>
                        </div>
                        <div class="mb-4">
                            <label for="request-type" class="block mb-2">リクエストの種類</label>
                            <select id="request-type" name="request-type" class="form-input w-full p-2 rounded-md">
                                <option>新しい動画の希望</option>
                                <option>新しい資料の希望</option>
                                <option>サイトの機能改善</option>
                                <option>その他</option>
                            </select>
                        </div>
                        <div class="mb-4">
                            <label for="file-attachment" class="block mb-2">添付ファイル（任意）</label>
                            <input type="file" id="file-attachment" name="file-attachment" class="form-input w-full p-2 rounded-md file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-yellow-100 file:text-yellow-800 hover:file:bg-yellow-200">
                        </div>
                        <div class="mb-6">
                            <label for="details" class="block mb-2">詳細内容</label>
                            <textarea id="details" name="details" rows="5" class="form-input w-full p-2 rounded-md" required></textarea>
                        </div>
                        <div class="text-center">
                            <button type="submit" id="submit-request-button" class="btn-primary py-3 px-8 rounded-lg w-full flex items-center justify-center">
                                <span id="submit-text">内容を送信する</span>
                                <div id="submit-loader" class="loader hidden"></div>
                            </button>
                        </div>
                    </form>
                </div>
            </section>
        </main>
    </div>

    <script>
    // --- 管理者設定エリア ---
    // Microsoft Azure Portalで取得した情報を設定してください
    const msalConfig = {
        auth: {
            clientId: "YOUR_CLIENT_ID_HERE", 
            authority: "https://login.microsoftonline.com/common", 
            redirectUri: window.location.origin,
        },
        cache: {
            cacheLocation: "sessionStorage", 
            storeAuthStateInCookie: false, 
        }
    };

    // OneDriveのフォルダ情報を設定してください
    const oneDriveConfig = {
        driveId: "YOUR_DRIVE_ID_HERE",
        // ★★★ OneDriveで動画ファイルの共有リンクを作成し、Base64エンコードした値を設定 ★★★
        introVideoUrl: "YOUR_INTRO_VIDEO_EMBED_URL_HERE",
        // 動画ファイルが格納されているフォルダのID
        videoFolderId: "YOUR_VIDEO_FOLDER_ID_HERE",
        // PDFファイルが格納されているフォルダのID
        documentFolderId: "YOUR_DOCUMENT_FOLDER_ID_HERE",
        // リクエストフォームの添付ファイルをアップロードするフォルダのID
        requestUploadFolderId: "YOUR_UPLOAD_FOLDER_ID_HERE"
    };
    
    // Microsoft Graph APIにリクエストする際の権限スコープ
    // ★★★ ファイルアップロードのために "Files.ReadWrite" を追加 ★★★
    const graphScopes = ["user.read", "files.read.all", "files.readwrite"];

    // リクエストフォームの送信先メールアドレス
    const mailToAddress = 'example@example.com';
    // --- ここまで管理者設定エリア ---


    const myMSALObj = new msal.PublicClientApplication(msalConfig);

    // ... (グローバル変数の定義は変更なし) ...
    let accountId = "";
    let videoData = [];
    let documentData = [];

    // --- DOM要素の取得 (初回訪問関連を追加) ---
    const welcomeScreen = document.getElementById('welcome-screen');
    const playIntroButton = document.getElementById('play-intro-button');
    const welcomeMessage = document.getElementById('welcome-message');
    const introVideoContainer = document.getElementById('intro-video-container');
    const introVideo = document.getElementById('intro-video');
    const closeIntroButton = document.getElementById('close-intro-button');
    const loginScreen = document.getElementById('login-screen');
    const mainContent = document.getElementById('main-content');
    const signInButton = document.getElementById('signInButton');
    const signOutButton = document.getElementById('signOutButton');
    // ... (その他のDOM要素取得は変更なし) ...


    document.addEventListener('DOMContentLoaded', () => {
        // 初回訪問かどうかの判定
        if (!localStorage.getItem('hasVisited')) {
            welcomeScreen.classList.remove('hidden');
        } else {
            loginScreen.classList.remove('hidden');
            selectAccount(); // 2回目以降は自動サインインを試みる
        }

        playIntroButton.addEventListener('click', () => {
            welcomeMessage.classList.add('hidden');
            introVideoContainer.classList.remove('hidden');
            introVideo.src = oneDriveConfig.introVideoUrl;
            introVideo.play();
        });

        closeIntroButton.addEventListener('click', () => {
            localStorage.setItem('hasVisited', 'true');
            welcomeScreen.classList.add('hidden');
            loginScreen.classList.remove('hidden');
            selectAccount();
        });
        
        // リクエストフォームの処理
        const requestForm = document.getElementById('request-form');
        requestForm.addEventListener('submit', handleFormSubmit);
    });
    
    // ... (signIn, signOut, selectAccount, handleResponse, showWelcomeMessage, getTokenPopup の各関数は変更なし) ...

    async function loadContentFromOneDrive() {
        try {
            const tokenResponse = await getTokenPopup({ scopes: graphScopes });
            const accessToken = tokenResponse.accessToken;

            const videoEndpoint = `https://graph.microsoft.com/v1.0/drives/${oneDriveConfig.driveId}/items/${oneDriveConfig.videoFolderId}/children?$select=name,webUrl,@microsoft.graph.downloadUrl,file`;
            const documentEndpoint = `https://graph.microsoft.com/v1.0/drives/${oneDriveConfig.driveId}/items/${oneDriveConfig.documentFolderId}/children?$select=name,webUrl,file`;

            const [videoResponse, documentResponse] = await Promise.all([
                fetch(videoEndpoint, { headers: { Authorization: `Bearer ${accessToken}` } }),
                fetch(documentEndpoint, { headers: { Authorization: `Bearer ${accessToken}` } })
            ]);

            if (!videoResponse.ok || !documentResponse.ok) {
                throw new Error(`Graph API error`);
            }

            const videoJson = await videoResponse.json();
            const documentJson = await documentResponse.json();
            
            videoData = videoJson.value.filter(item => item.file.mimeType.startsWith('video/')).map(item => ({
                title: item.name,
                description: `OneDrive上の動画ファイルです。`,
                downloadUrl: item['@microsoft.graph.downloadUrl'],
            }));
            
            documentData = documentJson.value.filter(item => item.file.mimeType === 'application/pdf').map(item => ({
                title: item.name,
                description: `OneDrive上のPDFファイルです。`,
                filePath: item.webUrl
            }));
            
            renderVideos(videoData);
            renderDocuments(documentData);

        } catch (error) {
            // ... (エラー処理は変更なし) ...
        }
    }

    async function handleFormSubmit(e) {
        e.preventDefault();
        const submitButton = document.getElementById('submit-request-button');
        const submitText = document.getElementById('submit-text');
        const submitLoader = document.getElementById('submit-loader');

        submitButton.disabled = true;
        submitText.classList.add('hidden');
        submitLoader.classList.remove('hidden');

        const fileInput = document.getElementById('file-attachment');
        const file = fileInput.files[0];
        let attachmentUrl = "";

        if (file) {
            try {
                const tokenResponse = await getTokenPopup({ scopes: ["files.readwrite"] });
                const accessToken = tokenResponse.accessToken;
                const uploadEndpoint = `https://graph.microsoft.com/v1.0/drives/${oneDriveConfig.driveId}/items/${oneDriveConfig.requestUploadFolderId}:/${file.name}:/content`;
                
                const uploadResponse = await fetch(uploadEndpoint, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': file.type
                    },
                    body: file
                });

                if (!uploadResponse.ok) {
                    throw new Error('File upload failed.');
                }
                const uploadedFile = await uploadResponse.json();
                attachmentUrl = uploadedFile.webUrl;
            } catch (error) {
                console.error(error);
                alert('ファイルのアップロードに失敗しました。');
                submitButton.disabled = false;
                submitText.classList.remove('hidden');
                submitLoader.classList.add('hidden');
                return;
            }
        }
        
        // メール作成
        const name = document.getElementById('name').value;
        const requestType = document.getElementById('request-type').value;
        const details = document.getElementById('details').value;
        
        let bodyContent = `お名前：\n${name}\n\nリクエストの種類：\n${requestType}\n\n詳細内容：\n${details}`;
        if (attachmentUrl) {
            bodyContent += `\n\n添付ファイルへのリンク：\n${attachmentUrl}`;
        }

        const subject = encodeURIComponent(`【学習サイト】新規リクエスト：${requestType}`);
        const body = encodeURIComponent(bodyContent);
        
        window.location.href = `mailto:${mailToAddress}?subject=${subject}&body=${body}`;
        
        alert('リクエストありがとうございます。お使いのメールソフトが起動しますので、内容をご確認の上、送信してください。');
        e.target.reset();

        submitButton.disabled = false;
        submitText.classList.remove('hidden');
        submitLoader.classList.add('hidden');
    }

    // ... (renderVideos, renderDocumentsなどの描画関数と、その他のイベントリスナーは変更なし) ...
    // ... (showWelcomeMessage関数内でgetFilesFromOneDriveをloadContentFromOneDriveに変更)
    function showWelcomeMessage(account) {
        loginScreen.classList.add('hidden');
        welcomeScreen.classList.add('hidden');

        mainContent.classList.remove('hidden');
        accountInfo.innerText = `ようこそ, ${account.name} さん`;
        accountInfo.classList.remove('hidden');
        
        // ログイン後にOneDriveからファイルを取得
        loadContentFromOneDrive();
    }
    </script>
</body>
</html>

